// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

model Company {
  id            String   @id @default(cuid()) // Primary key
  companyName   String   // Name of the company
  address       String?  // Company address
  phone         String?  // Company phone number
  email         String?  // Company email address
  archived      Int      @default(0) // Archive status
  createdBy     String   // Super admin user ID who created the company
  createdAt     DateTime @default(now())    // Company created timestamp

  // Relations
  staff          StaffRecord[]  // One-to-many relation with StaffRecord
  payrolls       Payroll[]      // One-to-many relation with Payroll
  payslips       Payslip[]      // One-to-many relation with Payslip
  staffUploads   StaffUpload[]  // One-to-many relation with StaffUpload
  payrollUploads PayrollUpload[] // One-to-many relation with PayrollUpload
  jobs           Job[]          // One-to-many relation with Job (this is the reverse relation)

  @@map("companies") // Maps the model to the "companies" table in the database
}



model StaffRecord {
  id            String   @id @default(cuid())
  staffId       String
  email         String
  firstName     String
  lastName      String
  department    String
  position      String
  phone         String?
  bankName      String?
  accountNumber String?
  bvn           String?
  
  // AUTH FIELDS (needed for login + registration)
  password      String?          // hashed password for login
  isRegistered  Boolean @default(false)
  role          String  @default("STAFF")   // SUPER_ADMIN | HR | STAFF

  isActive      Boolean  @default(true)

  companyId     String
  company       Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // NEW: who created this staff (HR / SUPER_ADMIN / uploader userId)
  createdBy     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  payrolls      Payroll[]
  payslips      Payslip[]

  @@unique([staffId, companyId])
  @@unique([email, companyId])
  @@map("staff_records")
}

model Payroll {
  id             String   @id @default(cuid())
  month          String
  year           Int
  staffRecordId  String
  companyId      String

  company        Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Basic salary components
  grossPay             Decimal @db.Decimal(18, 2)
  proratedGrossPay     Decimal @db.Decimal(18, 2)
  basicSalary          Decimal @db.Decimal(18, 2)
  housing              Decimal @db.Decimal(18, 2)
  transport            Decimal @db.Decimal(18, 2)
  dressing             Decimal @db.Decimal(18, 2)
  leaveAllowance       Decimal @db.Decimal(18, 2)
  entertainment        Decimal @db.Decimal(18, 2)
  utility              Decimal @db.Decimal(18, 2)

  // Calculations
  proratedGrossWithExtra Decimal @db.Decimal(18, 2)
  annualPension           Decimal @db.Decimal(18, 2)
  annualGrossPay          Decimal @db.Decimal(18, 2)
  consolidatedRelief      Decimal @db.Decimal(18, 2)
  taxableIncome           Decimal @db.Decimal(18, 2)

  // Deductions
  deductions          Decimal @db.Decimal(18, 2)
  payee               Decimal @db.Decimal(18, 2)
  pensionDeduction    Decimal @db.Decimal(18, 2)
  bonusKPI            Decimal @db.Decimal(18, 2)
  netSalary           Decimal @db.Decimal(18, 2)
  finalGross          Decimal @db.Decimal(18, 2)
  medicalContribution Decimal @db.Decimal(18, 2)

  // Employer contributions
  employerPension     Decimal @db.Decimal(18, 2)
  nsitf               Decimal @db.Decimal(18, 2)
  proratedSubTotal    Decimal @db.Decimal(18, 2)
  managementFee       Decimal @db.Decimal(18, 2)
  vatOnManagementFee  Decimal @db.Decimal(18, 2)
  totalInvoiceValue   Decimal @db.Decimal(18, 2)

  status      PayrollStatus @default(PROCESSED)
  uploadedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  staffRecord StaffRecord @relation(fields: [staffRecordId], references: [id], onDelete: Cascade)
  payslips    Payslip[]

  @@unique([staffRecordId, month, year, companyId])
  @@index([companyId, year, month])
  @@map("payrolls")
}

model Payslip {
  id            String   @id @default(cuid())
  payrollId     String
  staffRecordId String
  companyId     String

  company       Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  filePath      String
  fileName      String
  month         String
  year          Int
  grossPay      Decimal? @db.Decimal(18, 2)
  netPay        Decimal? @db.Decimal(18, 2)

  createdAt     DateTime @default(now())

  payroll       Payroll     @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  staffRecord   StaffRecord @relation(fields: [staffRecordId], references: [id], onDelete: Cascade)

  @@index([staffRecordId, year, month])
  @@map("payslips")
}

model StaffUpload {
  id          String   @id @default(cuid())
  companyId   String
  company     Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  fileName     String
  filePath     String
  totalRecords Int
  successful   Int
  failed       Int
  errors       String[]
  uploadedBy   String
  createdAt    DateTime @default(now())

  @@map("staff_uploads")
}

model PayrollUpload {
  id                String   @id @default(cuid())
  companyId         String
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  fileName          String
  filePath          String
  processedFilePath String?
  processedFileName String?

  totalRecords      Int
  successful        Int
  failed            Int
  errors            String[]

  uploadedBy        String
  createdAt         DateTime @default(now())

  @@map("payroll_uploads")
}

enum PayrollStatus {
  DRAFT
  PROCESSED
  PAID
  FAILED
}

//model for recruitment module
model JobApplication {
  id             String   @id @default(cuid()) // Primary key
  firstName      String   // Applicant's first name
  lastName       String   // Applicant's last name
  email          String   @unique // Applicant's email (must be unique)
  cv             String   // Path to the CV file
  status         String   @default("PENDING") // PENDING, SELECTED, REJECTED
  jobId          String   // Foreign key referencing Job
  job            Job      @relation(fields: [jobId], references: [id], onDelete: Cascade) // Relation to Job
  createdAt      DateTime @default(now())  // Timestamp when the application was created
  updatedAt      DateTime @updatedAt        // Timestamp when the application was last updated

  @@map("job_applications") // Maps the model to the "job_applications" table in the database
}


model Keyword {
  id          String   @id @default(cuid()) // Primary key
  name        String   @unique // Unique keyword name
  description String   // Description of the keyword
  jobId       String   // Foreign key referencing Job
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade) // Relation to Job

  @@map("keywords") // Maps the model to the "keywords" table in the database
}


model Job {
  id            String          @id @default(cuid()) // Primary key
  title         String          // Job title
  description   String          // Job description
  department    String
  position      String
  companyId     String          // Foreign key referencing Company
  company       Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)  // Relation to Company
  status        String          @default("ACTIVE") // ACTIVE, CLOSED, EXPIRED
  expirationDate DateTime       // Date when the job posting expires
  createdBy     String          // User who created the job
  createdAt     DateTime        @default(now())    // Job created timestamp
  updatedBy     String?         // User who last updated the job
  updatedAt     DateTime        @updatedAt          // Job last updated timestamp

  // Relations
  applications  JobApplication[] // One-to-many relation with JobApplication
  keywords      Keyword[]        // One-to-many relation with Keyword

  @@map("jobs") // Maps the model to the "jobs" table in the database
  @@index([companyId]) // Indexing companyId for optimized queries
}
