"use strict";(()=>{var r={};r.id=448,r.ids=[448],r.modules={53524:r=>{r.exports=require("@prisma/client")},20399:r=>{r.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:r=>{r.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:r=>{r.exports=require("buffer")},84770:r=>{r.exports=require("crypto")},92048:r=>{r.exports=require("fs")},20629:r=>{r.exports=require("fs/promises")},55315:r=>{r.exports=require("path")},76162:r=>{r.exports=require("stream")},21764:r=>{r.exports=require("util")},61574:r=>{r.exports=import("@prisma/adapter-pg")},8678:r=>{r.exports=import("pg")},85437:(r,e,t)=>{t.a(r,async(r,o)=>{try{t.r(e),t.d(e,{originalPathname:()=>h,patchFetch:()=>u,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>d});var n=t(49303),i=t(88716),s=t(60670),a=t(92072),c=r([a]);a=(c.then?(await c)():c)[0];let l=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/payslips/[id]/download/route",pathname:"/api/payslips/[id]/download",filename:"route",bundlePath:"app/api/payslips/[id]/download/route"},resolvedPagePath:"C:\\hrms-project\\src\\app\\api\\payslips\\[id]\\download\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:f}=l,h="/api/payslips/[id]/download/route";function u(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:d})}o()}catch(r){o(r)}})},92072:(r,e,t)=>{t.a(r,async(r,o)=>{try{t.r(e),t.d(e,{GET:()=>h,OPTIONS:()=>f});var n=t(52850),i=t(92606),s=t(7371),a=t(27305),c=t(20629),u=t.n(c),l=t(55315),p=t.n(l),d=r([n]);async function f(r){return(0,a.Ak)(r)}async function h(r,{params:e}){let t=r.headers.get("origin");try{let o;let c=r.headers.get("authorization");if(!c)return(0,a.o3)(s.Rf.error("Authorization header missing",401),t);let l=c.replace("Bearer ",""),d=(0,i.MH)(l,["HR","SUPER_ADMIN","STAFF"]),{id:f}=e,h={id:f};if("SUPER_ADMIN"!==d.role){if(!d.companyId)return(0,a.o3)(s.Rf.error("Company context missing for this user",400),t);h.companyId=d.companyId}let y=await n._.payslip.findFirst({where:h,include:{staffRecord:!0}});if(!y)return(0,a.o3)(s.Rf.error("Payslip not found",404),t);if("STAFF"===d.role&&y.staffRecordId!==d.userId)return(0,a.o3)(s.Rf.error("Forbidden",403),t);let m=y.filePath.startsWith("/")?y.filePath.slice(1):y.filePath,w=p().join(process.cwd(),"public",m);try{o=await u().readFile(w)}catch{return(0,a.o3)(s.Rf.error("Payslip file missing on server",500),t)}let A=new Uint8Array(o),g=new Blob([A],{type:"application/pdf"});return new Response(g,{headers:{"Content-Type":"application/pdf","Content-Disposition":`attachment; filename="${y.fileName}"`,"Cache-Control":"no-cache"}})}catch(r){return(0,a.o3)((0,s.zG)(r),t)}}n=(d.then?(await d)():d)[0],o()}catch(r){o(r)}})},92606:(r,e,t)=>{t.d(e,{MH:()=>u,fT:()=>s,mk:()=>c});var o=t(41482),n=t.n(o);function i(){let r=process.env.JWT_SECRET;if(!r)throw Error("JWT_SECRET environment variable is not set");return r}function s(r,e="7d"){return n().sign(r,i(),{expiresIn:e})}t(42023);let a=r=>{try{return n().verify(r,i())}catch{return null}},c=r=>{if(!r)throw Error("Authentication required");let e=a(r);if(!e)throw Error("Invalid or expired token");return e},u=(r,e)=>{let t=c(r);if(!e.includes(t.role))throw Error("Insufficient permissions");return t}},27305:(r,e,t)=>{t.d(e,{Ak:()=>s,o3:()=>i});var o=t(87070);let n=["http://localhost:5173","http://localhost:5173"].filter(Boolean);function i(r,e){return Object.entries(function(r){let e=r?n.includes(r)?r:void 0:n[0],t={"Access-Control-Allow-Methods":"GET,POST,PUT,PATCH,DELETE,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization","Access-Control-Allow-Credentials":"true"};return e&&(t["Access-Control-Allow-Origin"]=e),t}(e)).forEach(([e,t])=>{r.headers.set(e,t)}),r}function s(r){let e=r.headers.get("origin");return i(new o.NextResponse(null,{status:200}),e)}},52850:(r,e,t)=>{t.a(r,async(r,o)=>{try{t.d(e,{_:()=>w});var n=t(53524),i=t(61574),s=t(8678),a=t(92048),c=t.n(a),u=t(55315),l=t.n(u),p=r([i,s]);[i,s]=p.then?(await p)():p;let d=globalThis,f=l().join(process.cwd(),"certs","aiven-ca.pem"),h=c().readFileSync(f,"utf8"),y=d.pool??new s.Pool({connectionString:process.env.DATABASE_URL,ssl:{ca:h,rejectUnauthorized:!1}}),m=new i.PrismaPg(y),w=d.prisma??new n.PrismaClient({adapter:m,log:["query","error","warn"]});o()}catch(r){o(r)}})},7371:(r,e,t)=>{t.d(e,{Rf:()=>n,Z:()=>i,zG:()=>s});var o=t(87070);class n{static success(r,e="Success",t=200){return o.NextResponse.json({success:!0,message:e,data:r},{status:t})}static error(r="Error",e=400,t){return o.NextResponse.json({success:!1,message:r,errors:t||[]},{status:e})}static unauthorized(r="Unauthorized"){return this.error(r,401)}static forbidden(r="Forbidden"){return this.error(r,403)}static notFound(r="Resource not found"){return this.error(r,404)}static serverError(r="Internal server error"){return this.error(r,500)}}function i(r){if(r instanceof Error)return r.message;if("string"==typeof r)return r;try{return JSON.stringify(r)}catch{return"An unexpected error occurred"}}let s=r=>{console.error("API Error:",r);let e=i(r);return n.error(e,500)}}};var e=require("../../../../../webpack-runtime.js");e.C(r);var t=r=>e(e.s=r),o=e.X(0,[377,972,944],()=>t(85437));module.exports=o})();