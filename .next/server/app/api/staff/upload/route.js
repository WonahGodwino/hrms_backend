"use strict";(()=>{var e={};e.id=935,e.ids=[935],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},96076:e=>{e.exports=require("rimraf")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},9714:e=>{e.exports=require("constants")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},61574:e=>{e.exports=import("@prisma/adapter-pg")},8678:e=>{e.exports=import("pg")},97601:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{originalPathname:()=>m,patchFetch:()=>c,requestAsyncStorage:()=>d,routeModule:()=>f,serverHooks:()=>p,staticGenerationAsyncStorage:()=>u});var o=t(49303),i=t(88716),s=t(60670),n=t(64278),l=e([n]);n=(l.then?(await l)():l)[0];let f=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/staff/upload/route",pathname:"/api/staff/upload",filename:"route",bundlePath:"app/api/staff/upload/route"},resolvedPagePath:"C:\\hrms-project\\src\\app\\api\\staff\\upload\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:u,serverHooks:p}=f,m="/api/staff/upload/route";function c(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:u})}a()}catch(e){a(e)}})},64278:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{GET:()=>m,POST:()=>p});var o=t(52850),i=t(92606),s=t(7371),n=t(12957),l=t.n(n),c=t(20629),f=t(55315),d=t.n(f),u=e([o]);async function p(e){try{let r=e.headers.get("authorization");if(!r)return s.Rf.error("Authorization header missing",401);let t=r.replace("Bearer ",""),a=(0,i.MH)(t,["HR","SUPER_ADMIN"]);if(!a.companyId)return s.Rf.error("Company context missing for this user",400);let n=a.companyId,f=(await e.formData()).get("file");if(!f)return s.Rf.error("No file uploaded",400);let u=f.name.split(".").pop()?.toLowerCase();if(!["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"].includes(f.type)&&!["xlsx","xls","csv"].includes(u||""))return s.Rf.error("Invalid file type. Please upload Excel or CSV files.",400);let p=await f.arrayBuffer(),m=Buffer.from(p),h=[];try{let e=new(l()).Workbook;if("text/csv"===f.type||"csv"===u){let e=m.toString().split(/\r?\n/).filter(e=>e.trim());if(!e.length)return s.Rf.error("Empty CSV file",400);let r=e[0].split(",").map(e=>e.trim());for(let t=1;t<e.length;t++){let a=e[t].trim();if(!a)continue;let o=a.split(",").map(e=>e.trim()),i={};r.forEach((e,r)=>{i[e]=o[r]||""}),h.push(i)}}else{await e.xlsx.load(p);let r=e.worksheets[0];if(!r)return s.Rf.error("No worksheet found in Excel file",400);let t=[];r.getRow(1).eachCell((e,r)=>{t[r-1]=e.value?.toString().trim()||`col${r}`}),r.eachRow((e,r)=>{if(r<=1)return;let a={};e.eachCell((e,r)=>{a[t[r-1]]=e.value}),Object.values(a).some(e=>null!=e&&""!==e)&&h.push(a)})}}catch(e){return console.error("File parsing error:",e),s.Rf.error("Failed to parse file. Please check the file format.",400)}if(!h.length)return s.Rf.error("No data found in the file",400);let w=h[0],R=Object.keys(w),g=["staffId","email","firstName","lastName","department","position"].filter(e=>!R.includes(e));if(g.length>0)return s.Rf.error(`Missing required columns: ${g.join(", ")}. Found columns: ${R.join(", ")}`,400);let y={successful:0,failed:0,errors:[],records:[]};for(let e=0;e<h.length;e++){let r=h[e];try{let t=r.staffId||r.StaffID||r["Staff ID"],a=r.email||r.Email,i=r.firstName||r["First Name"],s=r.lastName||r["Last Name"],l=r.department||r.Department,c=r.position||r.Position,f=r.phone||r.Phone,d=r.bankName||r["Bank Name"],u=r.accountNumber||r["Account Number"],p=r.bvn||r.BVN,m=e+2;if(!t||!a||!i||!s||!l||!c){y.failed++,y.errors.push(`Row ${m}: Missing required fields`);continue}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)){y.failed++,y.errors.push(`Row ${m}: Invalid email format: ${a}`);continue}if(!/^[a-zA-Z0-9]{3,20}$/.test(t)){y.failed++,y.errors.push(`Row ${m}: Staff ID must be 3-20 alphanumeric characters`);continue}if(await o._.staffRecord.findFirst({where:{companyId:n,OR:[{staffId:t},{email:a.toLowerCase()}]}})){y.failed++,y.errors.push(`Row ${m}: Staff with ID ${t} or email ${a} already exists`);continue}let h=await o._.staffRecord.create({data:{staffId:t,email:a.toLowerCase(),firstName:i.trim(),lastName:s.trim(),department:l.trim(),position:c.trim(),phone:f?.toString().trim(),bankName:d?.toString().trim(),accountNumber:u?.toString().trim(),bvn:p?.toString().trim(),companyId:n}});y.records.push(h),y.successful++}catch(t){let r=t instanceof Error?t.message:"Unknown error";y.failed++,y.errors.push(`Row ${e+2}: ${r}`)}}let x=d().join(process.cwd(),"uploads","staff");await (0,c.mkdir)(x,{recursive:!0});let v=await o._.staffUpload.create({data:{companyId:n,fileName:f.name,filePath:d().join(x,f.name),totalRecords:h.length,successful:y.successful,failed:y.failed,errors:y.errors,uploadedBy:a.userId}});return await (0,c.writeFile)(d().join(x,f.name),m),s.Rf.success({results:y,uploadId:v.id,summary:{totalProcessed:h.length,successful:y.successful,failed:y.failed},...y.failed>0&&{failedRecordsInfo:`${y.failed} records failed. Check errors array for details.`}},`Staff records processing completed. Successful: ${y.successful}, Failed: ${y.failed}`)}catch(e){return(0,s.zG)(e)}}async function m(e){try{let r=e.headers.get("authorization");if(!r)return s.Rf.error("Authorization header missing",401);let t=r.replace("Bearer ","");(0,i.MH)(t,["HR","SUPER_ADMIN"]);let{searchParams:a}=new URL(e.url),o=a.get("action");if("template"===o){let e=new(l()).Workbook,r=e.addWorksheet("Staff Records");r.columns=[{header:"staffId",key:"staffId",width:15},{header:"email",key:"email",width:25},{header:"firstName",key:"firstName",width:15},{header:"lastName",key:"lastName",width:15},{header:"department",key:"department",width:20},{header:"position",key:"position",width:20},{header:"phone",key:"phone",width:15},{header:"bankName",key:"bankName",width:20},{header:"accountNumber",key:"accountNumber",width:20},{header:"bvn",key:"bvn",width:15}];let t=r.getRow(1);t.font={bold:!0,color:{argb:"FFFFFFFF"},size:12},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2F5496"}},t.alignment={vertical:"middle",horizontal:"center"},[{staffId:"EMP001",email:"john.doe@company.com",firstName:"John",lastName:"Doe",department:"Customer Service",position:"CSR",phone:"+2348012345678",bankName:"GTBank",accountNumber:"0123456789",bvn:"12345678901"},{staffId:"EMP002",email:"jane.smith@company.com",firstName:"Jane",lastName:"Smith",department:"Sales",position:"Telesales Agent",phone:"+2348098765432",bankName:"First Bank",accountNumber:"9876543210",bvn:"10987654321"}].forEach(e=>{r.addRow(e)}),r.eachRow((e,r)=>{r>1&&(e.alignment={vertical:"middle",horizontal:"left"},e.font={size:11},r%2==0&&(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}}))}),r.addRow([]),r.addRow(["IMPORTANT NOTES:"]),r.addRow(["- staffId: Unique staff ID (3-20 alphanumeric characters, REQUIRED)"]),r.addRow(["- email: Valid email address (REQUIRED)"]),r.addRow(["- firstName, lastName: Staff names (REQUIRED)"]),r.addRow(["- department, position: Staff details (REQUIRED)"]),r.addRow(["- phone, bankName, accountNumber, bvn: Optional fields"]);for(let e=r.rowCount-6;e<=r.rowCount;e++)r.getRow(e).font={italic:!0,color:{argb:"FFFF0000"},size:10};let a=await e.xlsx.writeBuffer();return new Response(a,{headers:{"Content-Type":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","Content-Disposition":'attachment; filename="staff-records-template.xlsx"',"Cache-Control":"no-cache"}})}return s.Rf.error("Invalid action")}catch(e){return(0,s.zG)(e)}}o=(u.then?(await u)():u)[0],a()}catch(e){a(e)}})},92606:(e,r,t)=>{t.d(r,{MH:()=>c,fT:()=>s,mk:()=>l});var a=t(41482),o=t.n(a);function i(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET environment variable is not set");return e}function s(e,r="7d"){return o().sign(e,i(),{expiresIn:r})}t(42023);let n=e=>{try{return o().verify(e,i())}catch{return null}},l=e=>{if(!e)throw Error("Authentication required");let r=n(e);if(!r)throw Error("Invalid or expired token");return r},c=(e,r)=>{let t=l(e);if(!r.includes(t.role))throw Error("Insufficient permissions");return t}},52850:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.d(r,{_:()=>d});var o=t(53524),i=t(61574),s=t(8678),n=e([i,s]);[i,s]=n.then?(await n)():n;let l=globalThis,c=l.pool??new s.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}}),f=new i.PrismaPg(c),d=l.prisma??new o.PrismaClient({adapter:f,log:["query","error","warn"]});a()}catch(e){a(e)}})},7371:(e,r,t)=>{t.d(r,{Rf:()=>o,zG:()=>i});var a=t(87070);class o{static success(e,r="Success",t=200){return a.NextResponse.json({success:!0,message:r,data:e},{status:t})}static error(e="Error",r=400,t){return a.NextResponse.json({success:!1,message:e,errors:t||[]},{status:r})}static unauthorized(e="Unauthorized"){return this.error(e,401)}static forbidden(e="Forbidden"){return this.error(e,403)}static notFound(e="Resource not found"){return this.error(e,404)}static serverError(e="Internal server error"){return this.error(e,500)}}let i=e=>(console.error("API Error:",e),e instanceof Error)?o.error(e.message):o.serverError()}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[377,443,70,957],()=>t(97601));module.exports=a})();