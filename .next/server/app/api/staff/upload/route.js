"use strict";(()=>{var e={};e.id=935,e.ids=[935],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},96076:e=>{e.exports=require("rimraf")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},9714:e=>{e.exports=require("constants")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},61574:e=>{e.exports=import("@prisma/adapter-pg")},8678:e=>{e.exports=import("pg")},97601:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{originalPathname:()=>m,patchFetch:()=>c,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>f});var a=t(49303),i=t(88716),s=t(60670),n=t(64278),l=e([n]);n=(l.then?(await l)():l)[0];let u=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/staff/upload/route",pathname:"/api/staff/upload",filename:"route",bundlePath:"app/api/staff/upload/route"},resolvedPagePath:"C:\\hrms-project\\src\\app\\api\\staff\\upload\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:d,staticGenerationAsyncStorage:f,serverHooks:p}=u,m="/api/staff/upload/route";function c(){return(0,s.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:f})}o()}catch(e){o(e)}})},64278:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{GET:()=>g,OPTIONS:()=>h,POST:()=>w});var a=t(87070),i=t(52850),s=t(92606),n=t(7371),l=t(12957),c=t.n(l),u=t(20629),d=t(55315),f=t.n(d),p=t(27305),m=e([i]);async function h(e){return(0,p.Ak)(e)}async function w(e){let r=e.headers.get("origin");try{let t=e.headers.get("authorization");if(!t)return(0,p.o3)(n.Rf.error("Authorization header missing",401),r);let o=t.replace("Bearer ",""),a=(0,s.MH)(o,["HR","SUPER_ADMIN"]);if(!a.companyId)return(0,p.o3)(n.Rf.error("Company context missing for this user",400),r);let l=a.companyId,d=(await e.formData()).get("file");if(!d)return(0,p.o3)(n.Rf.error("No file uploaded",400),r);let m=d.name.split(".").pop()?.toLowerCase();if(!["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"].includes(d.type)&&!["xlsx","xls","csv"].includes(m||""))return(0,p.o3)(n.Rf.error("Invalid file type. Please upload Excel or CSV files.",400),r);let h=await d.arrayBuffer(),w=Buffer.from(h),g=[],R=[];try{let e=new(c()).Workbook;if("text/csv"===d.type||"csv"===m){let e=w.toString().split(/\r?\n/).filter(e=>e.trim());if(!e.length)return(0,p.o3)(n.Rf.error("Empty CSV file",400),r);let t=e[0].split(",").map(e=>e.trim());for(let r=1;r<e.length;r++){let o=e[r].trim();if(!o)continue;let a=o.split(",").map(e=>e.trim()),i={};t.forEach((e,r)=>{i[e]=a[r]||""}),g.push(i)}}else{await e.xlsx.load(h);let t=e.worksheets[0];if(!t)return(0,p.o3)(n.Rf.error("No worksheet found in Excel file",400),r);let o=[];t.getRow(1).eachCell((e,r)=>{o[r-1]=e.value?.toString().trim()||`col${r}`}),t.eachRow((e,r)=>{if(r<=1)return;let t={};e.eachCell((e,r)=>{t[o[r-1]]=e.value}),Object.values(t).some(e=>null!=e&&""!==e)?g.push(t):R.push({...t,error:"Missing required fields or invalid data"})})}}catch(e){return console.error("File parsing error:",e),(0,p.o3)(n.Rf.error("Failed to parse file. Please check the file format.",400),r)}if(!g.length)return(0,p.o3)(n.Rf.error("No valid data found in the file",400),r);let y=g[0],v=Object.keys(y),x=["staffId","email","firstName","lastName","department","position"].filter(e=>!v.includes(e));if(x.length>0)return(0,p.o3)(n.Rf.error(`Missing required columns: ${x.join(", ")}. Found columns: ${v.join(", ")}`,400),r);let N={successful:0,failed:0,errors:[],records:[]};for(let e=0;e<g.length;e++){let r=g[e];try{let t=r.staffId||r.StaffID||r["Staff ID"],o=r.email||r.Email,s=r.firstName||r["First Name"],n=r.lastName||r["Last Name"],c=r.department||r.Department,u=r.position||r.Position,d=r.phone||r.Phone,f=r.bankName||r["Bank Name"],p=r.accountNumber||r["Account Number"],m=r.bvn||r.BVN,h=e+2;if(!t||!o||!s||!n||!c||!u){N.failed++,N.errors.push(`Row ${h}: Missing required fields`);continue}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)){N.failed++,N.errors.push(`Row ${h}: Invalid email format: ${o}`);continue}if(!/^[a-zA-Z0-9]{3,20}$/.test(t)){N.failed++,N.errors.push(`Row ${h}: Staff ID must be 3-20 alphanumeric characters`);continue}if(await i._.staffRecord.findFirst({where:{companyId:l,OR:[{staffId:t},{email:o.toLowerCase()}]}})){N.failed++,N.errors.push(`Row ${h}: Staff with ID ${t} or email ${o} already exists`);continue}let w=await i._.staffRecord.create({data:{staffId:t,email:o.toLowerCase(),firstName:s.trim(),lastName:n.trim(),department:c.trim(),position:u.trim(),phone:d?.toString().trim(),bankName:f?.toString().trim(),accountNumber:p?.toString().trim(),bvn:m?.toString().trim(),companyId:l,createdBy:a.userId}});N.records.push(w),N.successful++}catch(t){let r=t instanceof Error?t.message:"Unknown error";N.failed++,N.errors.push(`Row ${e+2}: ${r}`)}}let b=f().join(process.cwd(),"uploads","staff");await (0,u.mkdir)(b,{recursive:!0});let E=await i._.staffUpload.create({data:{companyId:l,fileName:d.name,filePath:f().join(b,d.name),totalRecords:g.length,successful:N.successful,failed:N.failed,errors:N.errors,uploadedBy:a.userId}});return await (0,u.writeFile)(f().join(b,d.name),w),(0,p.o3)(n.Rf.success({results:N,uploadId:E.id,summary:{totalProcessed:g.length,successful:N.successful,failed:N.failed},...N.failed>0&&{failedRecordsInfo:`${N.failed} records failed. Check errors array for details.`}},`Staff records processing completed. Successful: ${N.successful}, Failed: ${N.failed}`),r)}catch(e){return(0,p.o3)((0,n.zG)(e),r)}}async function g(e){let r=e.headers.get("origin");try{let t=e.headers.get("authorization");if(!t)return(0,p.o3)(n.Rf.error("Authorization header missing",401),r);let o=t.replace("Bearer ","");(0,s.MH)(o,["HR","SUPER_ADMIN"]);let{searchParams:i}=new URL(e.url),l=i.get("action");if("template"===l){let e=new(c()).Workbook,t=e.addWorksheet("Staff Records");t.columns=[{header:"staffId",key:"staffId",width:15},{header:"email",key:"email",width:25},{header:"firstName",key:"firstName",width:15},{header:"lastName",key:"lastName",width:15},{header:"department",key:"department",width:20},{header:"position",key:"position",width:20},{header:"phone",key:"phone",width:15},{header:"bankName",key:"bankName",width:20},{header:"accountNumber",key:"accountNumber",width:20},{header:"bvn",key:"bvn",width:15}];let o=t.getRow(1);o.font={bold:!0,color:{argb:"FFFFFFFF"},size:12},o.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2F5496"}},o.alignment={vertical:"middle",horizontal:"center"},[{staffId:"EMP001",email:"john.doe@company.com",firstName:"John",lastName:"Doe",department:"Customer Service",position:"CSR",phone:"+2348012345678",bankName:"GTBank",accountNumber:"0123456789",bvn:"12345678901"},{staffId:"EMP002",email:"jane.smith@company.com",firstName:"Jane",lastName:"Smith",department:"Sales",position:"Telesales Agent",phone:"+2348098765432",bankName:"First Bank",accountNumber:"9876543210",bvn:"10987654321"}].forEach(e=>{t.addRow(e)}),t.eachRow((e,r)=>{r>1&&(e.alignment={vertical:"middle",horizontal:"left"},e.font={size:11},r%2==0&&(e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}}))}),t.addRow([]),t.addRow(["IMPORTANT NOTES:"]),t.addRow(["- staffId: Unique staff ID (3-20 alphanumeric characters, REQUIRED)"]),t.addRow(["- email: Valid email address (REQUIRED)"]),t.addRow(["- firstName, lastName: Staff names (REQUIRED)"]),t.addRow(["- department, position: Staff details (REQUIRED)"]),t.addRow(["- phone, bankName, accountNumber, bvn: Optional fields"]);for(let e=t.rowCount-6;e<=t.rowCount;e++)t.getRow(e).font={italic:!0,color:{argb:"FFFF0000"},size:10};let i=await e.xlsx.writeBuffer(),s=new a.NextResponse(i,{headers:{"Content-Type":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","Content-Disposition":'attachment; filename="staff-records-template.xlsx"',"Cache-Control":"no-cache"}});return(0,p.o3)(s,r)}return(0,p.o3)(n.Rf.error("Invalid action"),r)}catch(e){return(0,p.o3)((0,n.zG)(e),r)}}i=(m.then?(await m)():m)[0],o()}catch(e){o(e)}})},92606:(e,r,t)=>{t.d(r,{MH:()=>c,fT:()=>s,mk:()=>l});var o=t(41482),a=t.n(o);function i(){let e=process.env.JWT_SECRET;if(!e)throw Error("JWT_SECRET environment variable is not set");return e}function s(e,r="7d"){return a().sign(e,i(),{expiresIn:r})}t(42023);let n=e=>{try{return a().verify(e,i())}catch{return null}},l=e=>{if(!e)throw Error("Authentication required");let r=n(e);if(!r)throw Error("Invalid or expired token");return r},c=(e,r)=>{let t=l(e);if(!r.includes(t.role))throw Error("Insufficient permissions");return t}},27305:(e,r,t)=>{t.d(r,{Ak:()=>s,o3:()=>i});var o=t(87070);let a=["http://localhost:5173","http://localhost:5173"].filter(Boolean);function i(e,r){return Object.entries(function(e){let r=e?a.includes(e)?e:void 0:a[0],t={"Access-Control-Allow-Methods":"GET,POST,PUT,PATCH,DELETE,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization","Access-Control-Allow-Credentials":"true"};return r&&(t["Access-Control-Allow-Origin"]=r),t}(r)).forEach(([r,t])=>{e.headers.set(r,t)}),e}function s(e){let r=e.headers.get("origin");return i(new o.NextResponse(null,{status:200}),r)}},52850:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.d(r,{_:()=>g});var a=t(53524),i=t(61574),s=t(8678),n=t(92048),l=t.n(n),c=t(55315),u=t.n(c),d=e([i,s]);[i,s]=d.then?(await d)():d;let f=globalThis,p=u().join(process.cwd(),"certs","aiven-ca.pem"),m=l().readFileSync(p,"utf8"),h=f.pool??new s.Pool({connectionString:process.env.DATABASE_URL,ssl:{ca:m,rejectUnauthorized:!1}}),w=new i.PrismaPg(h),g=f.prisma??new a.PrismaClient({adapter:w,log:["query","error","warn"]});o()}catch(e){o(e)}})},7371:(e,r,t)=>{t.d(r,{Rf:()=>a,Z:()=>i,zG:()=>s});var o=t(87070);class a{static success(e,r="Success",t=200){return o.NextResponse.json({success:!0,message:r,data:e},{status:t})}static error(e="Error",r=400,t){return o.NextResponse.json({success:!1,message:e,errors:t||[]},{status:r})}static unauthorized(e="Unauthorized"){return this.error(e,401)}static forbidden(e="Forbidden"){return this.error(e,403)}static notFound(e="Resource not found"){return this.error(e,404)}static serverError(e="Internal server error"){return this.error(e,500)}}function i(e){if(e instanceof Error)return e.message;if("string"==typeof e)return e;try{return JSON.stringify(e)}catch{return"An unexpected error occurred"}}let s=e=>{console.error("API Error:",e);let r=i(e);return a.error(r,500)}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[377,972,944,957],()=>t(97601));module.exports=o})();